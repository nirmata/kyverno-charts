---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.18.0
  name: remediationrecords.serviceagents.nirmata.io
spec:
  group: serviceagents.nirmata.io
  names:
    kind: RemediationRecord
    listKind: RemediationRecordList
    plural: remediationrecords
    shortNames:
    - rr
    singular: remediationrecord
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.collectorId
      name: Collector
      type: string
    - jsonPath: .status.totalResources
      name: Resources
      type: integer
    - jsonPath: .status.lastUpdateTime
      name: Last Update
      type: date
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          RemediationRecord is the Schema for the remediationrecords API.
          It tracks the remediation state for resources processed by a specific collector instance.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: RemediationRecordSpec defines the desired state of RemediationRecord.
            properties:
              collectorId:
                description: CollectorID identifies the collector instance this record
                  tracks
                type: string
              collectorTarget:
                description: CollectorTarget references the target this record tracks
                properties:
                  argoHub:
                    description: ArgoHubTarget holds cluster-based targeting configuration
                    properties:
                      appSelector:
                        description: |-
                          ArgoAppSelector defines how to select Argo applications for remediation
                          If not specified, no applications will be selected
                        properties:
                          allApps:
                            description: |-
                              AllApps indicates whether to select all applications (wildcard behavior)
                              When true, other selector fields are ignored
                            type: boolean
                          labelSelector:
                            description: LabelSelector is used to select applications
                              based on their labels
                            properties:
                              matchExpressions:
                                description: matchExpressions is a list of label selector
                                  requirements. The requirements are ANDed.
                                items:
                                  description: |-
                                    A label selector requirement is a selector that contains values, a key, and an operator that
                                    relates the key and values.
                                  properties:
                                    key:
                                      description: key is the label key that the selector
                                        applies to.
                                      type: string
                                    operator:
                                      description: |-
                                        operator represents a key's relationship to a set of values.
                                        Valid operators are In, NotIn, Exists and DoesNotExist.
                                      type: string
                                    values:
                                      description: |-
                                        values is an array of string values. If the operator is In or NotIn,
                                        the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                        the values array must be empty. This array is replaced during a strategic
                                        merge patch.
                                      items:
                                        type: string
                                      type: array
                                      x-kubernetes-list-type: atomic
                                  required:
                                  - key
                                  - operator
                                  type: object
                                type: array
                                x-kubernetes-list-type: atomic
                              matchLabels:
                                additionalProperties:
                                  type: string
                                description: |-
                                  matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels
                                  map is equivalent to an element of matchExpressions, whose key field is "key", the
                                  operator is "In", and the values array contains only "value". The requirements are ANDed.
                                type: object
                            type: object
                            x-kubernetes-map-type: atomic
                          names:
                            description: Names is a list of specific Argo application
                              names to select
                            items:
                              type: string
                            type: array
                        type: object
                      clusterNames:
                        description: |-
                          ClusterNames is a list of cluster names to remediate
                          Optional when LocalCluster is true (will use current cluster)
                        items:
                          type: string
                        type: array
                      clusterServerUrls:
                        description: ClusterServerUrls is a list of cluster server
                          URLs (optional)
                        items:
                          type: string
                        type: array
                    type: object
                  localCluster:
                    description: LocalClusterTarget holds local cluster-based targeting
                      configuration
                    properties:
                      repoNamespaceMappingRef:
                        description: |-
                          RepoNamespaceMappingRef defines a reference to a ConfigMap containing
                          mapping between git repositories and target namespaces
                        properties:
                          key:
                            default: mapping
                            description: Key is the key within the ConfigMap containing
                              the mapping data
                            type: string
                          name:
                            description: Name is the name of the ConfigMap
                            type: string
                          namespace:
                            description: Namespace is the namespace of the ConfigMap
                            type: string
                        required:
                        - name
                        type: object
                    required:
                    - repoNamespaceMappingRef
                    type: object
                  vcs:
                    description: VCSTarget holds VCS-based targeting configuration
                    properties:
                      policies:
                        description: PolicyRepos defines the list of policies with
                          their git repositories
                        items:
                          description: PolicyRepo defines a policy with its git repository
                            location
                          properties:
                            name:
                              description: Name is the name of the policy
                              type: string
                            path:
                              description: Path is the path to the policy within the
                                repository
                              type: string
                            ref:
                              description: Ref is the git reference (branch, tag,
                                or commit) to use
                              type: string
                            repo:
                              description: RepoURL is the repository URL containing
                                the policy
                              type: string
                          required:
                          - name
                          - path
                          - ref
                          - repo
                          type: object
                        type: array
                      resources:
                        description: ResourceRepos defines the list of resources with
                          their git repositories and associated policies
                        items:
                          description: ResourceRepo defines a resource with its git
                            repository location and associated policies
                          properties:
                            name:
                              description: Name is the name of the resource
                              type: string
                            path:
                              description: Path is the path to the resource within
                                the repository
                              type: string
                            policyRefs:
                              description: |-
                                PolicyRefs is a list of policy names that should be applied to this resource
                                These policy names correspond to the policies defined in the VCSTarget.PolicyRepos list
                              items:
                                type: string
                              type: array
                            ref:
                              description: Ref is the git reference (branch, tag,
                                or commit) to use
                              type: string
                            repo:
                              description: RepoURL is the repository URL containing
                                the resource
                              type: string
                          required:
                          - name
                          - path
                          - policyRefs
                          - ref
                          - repo
                          type: object
                        type: array
                    required:
                    - policies
                    - resources
                    type: object
                type: object
                x-kubernetes-validations:
                - message: localCluster and argoHub cannot both be set
                  rule: '!(has(self.localCluster) && has(self.argoHub))'
              remediatorRef:
                description: RemediatorRef references the parent Remediator name
                type: string
            required:
            - collectorId
            type: object
          status:
            description: RemediationRecordStatus defines the observed state of RemediationRecord.
            properties:
              lastUpdateTime:
                description: LastUpdateTime is when this record was last updated
                format: date-time
                type: string
              resourceStates:
                additionalProperties:
                  description: ResourceRemediationState tracks the remediation state
                    of a single resource.
                  properties:
                    actionMetadata:
                      description: ActionMetadata contains metadata about the remediation
                        action taken
                      properties:
                        gitIssueAction:
                          description: GitIssueAction contains metadata about a Git
                            issue action taken
                          properties:
                            issues:
                              description: Issues is the list of issues created for
                                this resource
                              items:
                                description: IssueInfo contains information about
                                  a single issue.
                                properties:
                                  createdAt:
                                    description: CreatedAt is when the issue was created
                                    format: date-time
                                    type: string
                                  issueNumber:
                                    description: IssueNumber is the issue number
                                    type: integer
                                  issueUrl:
                                    description: IssueURL is the URL of the created
                                      issue
                                    type: string
                                  policies:
                                    description: Policies is the list of policies
                                      this issue addresses
                                    items:
                                      type: string
                                    type: array
                                type: object
                              type: array
                          type: object
                        gitPRAction:
                          description: GitPRAction contains metadata about a Git PR
                            action taken
                          properties:
                            prs:
                              description: PRs is the list of pull requests created
                                for this resource
                              items:
                                description: PRInfo contains information about a single
                                  pull request.
                                properties:
                                  branchName:
                                    description: BranchName is the name of the branch
                                      where the PR was created
                                    type: string
                                  commitSha:
                                    description: CommitSHA is the commit SHA of the
                                      PR
                                    type: string
                                  createdAt:
                                    description: CreatedAt is when the PR was created
                                    format: date-time
                                    type: string
                                  excludedPolicies:
                                    description: ExcludedPolicies is the list of policies
                                      that were excluded from the PR
                                    items:
                                      type: string
                                    type: array
                                  lastProcessedCommentId:
                                    description: LastProcessedCommentID is the ID
                                      of the last comment processed on this PR
                                    format: int64
                                    type: integer
                                  policies:
                                    description: Policies is the list of policies
                                      this PR addresses
                                    items:
                                      type: string
                                    type: array
                                  prNumber:
                                    description: PRNumber is the pull request number
                                    type: integer
                                  prUrl:
                                    description: PRURL is the URL of the created pull
                                      request
                                    type: string
                                type: object
                              type: array
                          type: object
                        jiraTicketAction:
                          description: JiraTicketAction contains metadata about a
                            Jira ticket action taken
                          properties:
                            ticketKey:
                              description: TicketKey is the Jira ticket key (e.g.,
                                "PROJ-123")
                              type: string
                            ticketUrl:
                              description: TicketURL is the URL of the created Jira
                                ticket
                              type: string
                          type: object
                      type: object
                    lastActionTime:
                      description: LastActionTime is when the last remediation action
                        was taken
                      format: date-time
                      type: string
                    resourceHash:
                      description: ResourceHash is the SHA256 hash of the resource
                        content
                      type: string
                    violations:
                      description: Violations is the list of policy violations detected
                      items:
                        description: ViolationFingerprint uniquely identifies a policy
                          violation.
                        properties:
                          message:
                            description: Message is the violation message
                            type: string
                          policy:
                            description: Policy is the name of the violated policy
                            type: string
                          rule:
                            description: Rule is the specific rule within the policy
                              that was violated
                            type: string
                        required:
                        - message
                        - policy
                        - rule
                        type: object
                      type: array
                  required:
                  - resourceHash
                  - violations
                  type: object
                description: |-
                  ResourceStates maps resource keys to their remediation state
                  Key format: "namespace/kind/name" or "kind/name" for cluster-scoped resources
                type: object
              totalResources:
                description: TotalResources is the total number of resources tracked
                format: int32
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
