# Auto-merge for trivial bot PRs (appVersion-only bumps).
#
# When a PR is created by n4k-release-bot with the label "bot-auto-merge",
# this workflow waits for lint to pass and then auto-approves and merges.

name: Auto-merge Bot PRs

on:
  pull_request:
    types: [labeled, opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    if: >
      contains(github.event.pull_request.labels.*.name, 'bot-auto-merge') &&
      (github.event.pull_request.user.login == 'n4k-release-bot[bot]' ||
       github.event.pull_request.user.login == 'github-actions[bot]')
    runs-on: ubuntu-latest
    steps:
      - name: Wait for checks
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Wait up to 10 minutes for checks to complete
            const maxWait = 600;
            const interval = 30;
            let elapsed = 0;

            while (elapsed < maxWait) {
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha,
              });

              const pending = checks.check_runs.filter(
                c => c.status !== 'completed' && c.name !== 'auto-merge'
              );

              if (pending.length === 0) {
                const failed = checks.check_runs.filter(
                  c => c.conclusion === 'failure' && c.name !== 'auto-merge'
                );
                if (failed.length > 0) {
                  core.setFailed(`Checks failed: ${failed.map(c => c.name).join(', ')}`);
                  return;
                }
                console.log('All checks passed');
                break;
              }

              console.log(`Waiting for ${pending.length} check(s)...`);
              await new Promise(r => setTimeout(r, interval * 1000));
              elapsed += interval;
            }

            if (elapsed >= maxWait) {
              core.setFailed('Timed out waiting for checks');
            }

      - name: Auto-approve
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              event: 'APPROVE',
              body: 'Auto-approved by n4k-release-bot (trivial appVersion bump).',
            });

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --repo ${{ github.repository }}
